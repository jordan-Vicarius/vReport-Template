-- Key Vulnerability Metrics
-- Centralized metrics that can be reused across multiple pages
SELECT 
    'Active Vulnerabilities' as metric_name,
    COUNT(CASE WHEN event_type = 'DetectedActive' THEN 1 END) as metric_value,
    'count' as metric_type
FROM "mitigation_performance_view"
UNION ALL
SELECT 
    'Mitigated Vulnerabilities' as metric_name,
    COUNT(CASE WHEN event_type = 'MitigatedVulnerability' THEN 1 END) as metric_value,
    'count' as metric_type
FROM "mitigation_performance_view"
UNION ALL
SELECT 
    'Critical Vulnerabilities' as metric_name,
    COUNT(*) as metric_value,
    'count' as metric_type
FROM activevulnerabilities av
JOIN endpoints e ON av.endpoint_id = e.endpoint_id
WHERE e.alive = true 
    AND av.vulnerability_v3_base_score >= 9.0
UNION ALL
SELECT 
    'High Vulnerabilities' as metric_name,
    COUNT(*) as metric_value,
    'count' as metric_type
FROM activevulnerabilities av
JOIN endpoints e ON av.endpoint_id = e.endpoint_id
WHERE e.alive = true 
    AND av.vulnerability_v3_base_score >= 7.0 
    AND av.vulnerability_v3_base_score < 9.0
UNION ALL
SELECT 
    'Total Vulnerabilities' as metric_name,
    COUNT(*) as metric_value,
    'count' as metric_type
FROM activevulnerabilities av
JOIN endpoints e ON av.endpoint_id = e.endpoint_id
WHERE e.alive = true;
