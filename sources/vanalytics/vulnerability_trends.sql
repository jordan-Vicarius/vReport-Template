-- Vulnerability Trends by Date
-- Provides daily counts of detected, active, and mitigated vulnerabilities
WITH daily_events AS (
    SELECT 
        DATE(h_created_at) as event_date,
        event_type,
        COUNT(*) as event_count
    FROM incident_view
    WHERE h_created_at IS NOT NULL
        AND event_type IN ('DetectedActive', 'MitigatedVulnerability')
    GROUP BY DATE(h_created_at), event_type
),
date_series AS (
    SELECT DISTINCT event_date
    FROM daily_events
    ORDER BY event_date
),
vulnerability_summary AS (
    SELECT 
        ds.event_date,
        COALESCE(SUM(CASE WHEN de.event_type = 'DetectedActive' THEN de.event_count ELSE 0 END), 0) as detected_count,
        COALESCE(SUM(CASE WHEN de.event_type = 'MitigatedVulnerability' THEN de.event_count ELSE 0 END), 0) as mitigated_count
    FROM date_series ds
    LEFT JOIN daily_events de ON ds.event_date = de.event_date
    GROUP BY ds.event_date
),
cumulative_active AS (
    SELECT 
        event_date,
        detected_count,
        mitigated_count,
        SUM(detected_count) OVER (ORDER BY event_date) - SUM(mitigated_count) OVER (ORDER BY event_date) as active_count
    FROM vulnerability_summary
)
SELECT 
    event_date,
    detected_count,
    mitigated_count,
    active_count,
    -- Calculate daily net change
    detected_count - mitigated_count as net_daily_change
FROM cumulative_active
ORDER BY event_date DESC;
