-- CMMC Vulnerability Assessment Summary
-- Maps to CMMC controls: RA.L2-3.11.2, RA.L2-3.11.3, CA.L2-3.12.1
SELECT
    COUNT(*) as total_vulnerabilities,
    COUNT(CASE WHEN av.vulnerability_v3_base_score >= 9.0 THEN 1 END) as critical_vulnerabilities,
    COUNT(CASE WHEN av.vulnerability_v3_base_score >= 7.0 AND av.vulnerability_v3_base_score < 9.0 THEN 1 END) as high_vulnerabilities,
    COUNT(CASE WHEN av.vulnerability_v3_base_score >= 4.0 AND av.vulnerability_v3_base_score < 7.0 THEN 1 END) as medium_vulnerabilities,
    COUNT(CASE WHEN av.vulnerability_v3_base_score > 0 AND av.vulnerability_v3_base_score < 4.0 THEN 1 END) as low_vulnerabilities,
    COUNT(DISTINCT av.endpoint_id) as affected_endpoints,
    COUNT(DISTINCT av.asset) as affected_assets,
    AVG(av.vulnerability_v3_base_score)::numeric(10,2) as avg_cvss_score,  -- Use casting to round to 2 decimal places
    MAX(av.vulnerability_v3_base_score) as max_cvss_score,
    -- CMMC compliance indicators
    CASE
        WHEN COUNT(CASE WHEN av.vulnerability_v3_base_score >= 9.0 THEN 1 END) = 0 THEN 'Compliant'
        WHEN COUNT(CASE WHEN av.vulnerability_v3_base_score >= 9.0 THEN 1 END) <= 5 THEN 'Partial'
        ELSE 'Non-Compliant'
    END as cmmc_compliance_status,
    CURRENT_DATE as assessment_date
FROM activevulnerabilities av
WHERE av.vulnerability_v3_base_score IS NOT NULL;